<?phpob_start();require '../../inc/const.php';require '../../inc/secure.php';$sumber = $_POST['sumber'];$sumberKode = $_POST['sumberKode'];$sumberSentKode = $_POST['sumberSentKode'];$sm_kode = $_POST['smKode'];$usn = $_COOKIE["usn"];$uDB = str_replace("'","\'",$usn); //Untuk penggunaan Username dalam Insert Update Delete SQL//Tentang Disposisi checkbox$box = (isset($_POST["ckDis"]) ? $_POST["ckDis"] : "");	$disposisi = "";while (list ($key,$val) = @each ($box)) {	$disposisi .= "$val,";} if (strlen($disposisi) != 0){ $disposisi = substr($disposisi,0,strlen($disposisi)-1);}$sendTo = $_POST["txtKepada"];$sendToDB = str_replace("'","\'",$sendTo); //Untuk penggunaan Username dalam Insert Update Delete SQL$sendMsg = str_replace("'","\'",$_POST["txtKetDis"]);if ($sm_kode != 0) {		//masukkan ke table surat_masuk_sent		$kodeApp = substr(str_shuffle(str_repeat('abcdefghijklmnopqrstuvwxyz1234567890',2)),0,10);				$sql = "INSERT INTO surat_masuk_sent(			pengirim,penerima,surat_masuk_kode,sent_kode,disposisi,tindak_lanjut,tgl,kode_app) VALUES (			'$uDB','$sendToDB',$sm_kode,$sumberSentKode,'$disposisi','$sendMsg',now(),'$kodeApp')";				$rsSMS = mysql_query($sql);		//echo "<b>sms :</b> $sql <br />";		if (mysql_errno() != 0) { echo "sms=".mysql_errno(); }				//masukkan ke table surat_masuk_inbox		if (strlen($sendTo)!=0) { //Jika sendTo ada isinya maka...					//Mendapatkan no kode surat_masuk_sent			$sql = "SELECT kode FROM surat_masuk_sent WHERE surat_masuk_kode=$sm_kode AND pengirim='$uDB' AND penerima='$sendToDB'";			$resSMS = mysql_query($sql);						if (mysql_errno() != 0) { echo "getkode=".mysql_errno(); };						$sms_kode = 0; //Surat_Masuk_Sent Kode			if ($row = mysql_fetch_assoc($resSMS)) { $sms_kode = $row['kode']; }						//Dipisah SentTo nya			$arrKe = explode(",",$sendTo);						//looping sepanjang array			$sql = '';						$emailKe = "";	//Untuk Keperluan Kirim Notifikasi EMAIL						for ($i=0, $c=count($arrKe); $i < $c; $i++)			{				$plh="SELECT `usn`,`AD_mail` FROM m_user WHERE usn=(SELECT `plh`FROM m_user WHERE usn='$arrKe[$i]' AND flag_status!='0')";				$resPLH = mysql_query($plh);				$rowPLH = mysql_fetch_assoc($resPLH);				if($rowPLH['usn'])					{ $sKe = $rowPLH['usn'];}				else				{				$sKe = $arrKe[$i];				}				$sql = "$sql ('$sKe','$usn','$sendTo',$sm_kode,$sms_kode,'$disposisi','$sendMsg',now())";								$emailKe .= $sKe;	//Untuk Keperluan Kirim Notifikasi EMAIL								if ($i+1 != $c) { 					$sql = "$sql ,"; 					$emailKe .= ";"; //Untuk Keperluan Kirim Notifikasi EMAIL 				}; //Tambahkan , jika belum record yg terakhir dimasukkan			}						$sql = "INSERT INTO surat_masuk_inbox(					usn,pengirim,penerima,surat_masuk_kode,sent_kode, disposisi,tindak_lanjut,tgl) VALUES $sql";						$rsSMT = mysql_query($sql);						//Untuk Keperluan Kirim Notifikasi EMAIL			$pesanT = file_get_contents("../../inc/template_notifikasi_SMI.html");						//Keterangan Kalau Ada			$keterangan = "";			$sql = "SELECT no_surat, dari, kepada, perihal, keterangan FROM surat_masuk WHERE kode=$sm_kode";			$rs = mysql_query($sql);			if ($row = mysql_fetch_assoc($rs)) {				$no_surat = $row["no_surat"];				$dari = $row["dari"];				$kepada = $row["kepada"];				$perihal = $row["perihal"];				$ket = $row["keterangan"];			}						if (!empty($ket)) {				$keterangan = "<tr><td class=\"c1\">Keterangan</td><td class=\"c2\">:</td>					<td class=\"c3\">".nl2br($ket)."</td></tr>";			}			$waktu = date('d-M-Y H:i:s');			// pemberi disposisi surat			$selectnama=mysql_fetch_array(mysql_query("SELECT AD_displayName FROM m_user WHERE usn='$usn'"));			$nama=$selectnama['AD_displayName'];						$rS = array('{noSurat}', '{dari}', '{kepada}', '{perihal}', '{keterangan}','{waktu}','{nama}');			$rT = array($no_surat, $dari, $kepada, $perihal, $keterangan, $waktu, $nama);			$pesan = str_replace($rS,$rT,$pesanT);						$judul = "Surat Masuk Inbox Baru";						echo "<div style='display:none'>";			kirimEmail($emailKe, $judul, $pesan);			echo "</div>";			//End Untuk Keperluan Kirim Notifikasi EMAIL						//echo "<b>smi :</b> $sql <br />";			if (mysql_errno() != 0) { echo "inbox=".mysql_errno(); }						if ($sumber == 'inbox') {				$sql = "UPDATE surat_masuk_inbox SET flag_done=1, flag_read=1 WHERE kode=$sumberKode";				$resIBX = mysql_query($sql);			}			else if ($sumber == 'sent') {}		}			}?><!DOCTYPE html><HTML><HEAD><META http-equiv="Content-Type" content="text/html; charset=utf-8"><TITLE>AMS ( Aplikasi Manajemen Surat )</TITLE><link type="text/css" href="../../informasi.css" rel="stylesheet" /><SCRIPT LANGUAGE="JavaScript"><!--langsung menampilkan data surat masuk terbaru, tanpa refresh halaman terlebih dahulu	window.opener.document.getElementById('cmdCari').click();	setTimeout('self.close()',5000);//--></SCRIPT></HEAD><BODY><DIV id="top-header"></DIV><DIV id="outer">	<DIV id="header">INFORMASI !!!</DIV>	<DIV id="content">		Data <b>Surat Masuk</b> sudah berhasil Didisposisikan.		<DIV id="action">			<a href="#" onclick="window.close()">Tutup Window Ini (5 Detik Menutup Sendiri)</a>		</DIV>	</DIV></DIV><DIV id="version"><?php include "../../../tools/version.php" ?></DIV><DIV id="copyright"><?php echo $copyright ?></DIV></BODY></HTML>